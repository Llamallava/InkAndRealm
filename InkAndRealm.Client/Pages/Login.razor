@page "/login"
@using InkAndRealm.Shared
@using InkAndRealm.Client.State
@inject HttpClient Http
@inject UserState UserState

<h1>Account</h1>

@if (UserState.CurrentUser is not null)
{
    <p>Signed in as <strong>@UserState.CurrentUser.Username</strong> (Id: @UserState.CurrentUser.UserId).</p>
}

<div class="row">
    <div class="col-md-6">
        <h2>Create account</h2>
        <EditForm Model="registerRequest" OnSubmit="RegisterAsync">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <InputText class="form-control" @bind-Value="registerRequest.Username" />
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <InputText class="form-control" type="password" @bind-Value="registerRequest.Password" />
            </div>
            <button class="btn btn-primary" type="submit">Register</button>
        </EditForm>
        @if (!string.IsNullOrWhiteSpace(registerMessage))
        {
            <p class="mt-2">@registerMessage</p>
        }
    </div>
    <div class="col-md-6">
        <h2>Log in</h2>
        <EditForm Model="loginRequest" OnSubmit="LoginAsync">
            <div class="mb-3">
                <label class="form-label">Username</label>
                <InputText class="form-control" @bind-Value="loginRequest.Username" />
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <InputText class="form-control" type="password" @bind-Value="loginRequest.Password" />
            </div>
            <button class="btn btn-primary" type="submit">Log in</button>
        </EditForm>
        @if (!string.IsNullOrWhiteSpace(loginMessage))
        {
            <p class="mt-2">@loginMessage</p>
        }
    </div>
</div>

@code {
    private readonly RegisterRequest registerRequest = new();
    private readonly LoginRequest loginRequest = new();
    private string? registerMessage;
    private string? loginMessage;
    private async Task RegisterAsync()
    {
        registerMessage = null;
        loginMessage = null;

        var response = await Http.PostAsJsonAsync("api/auth/register", registerRequest);
        if (response.IsSuccessStatusCode)
        {
            var user = await response.Content.ReadFromJsonAsync<AuthResponse>();
            await UserState.SetUserAsync(user);
            registerMessage = user is null ? "Registration succeeded." : $"Registered as {user.Username}.";
            registerRequest.Password = string.Empty;
            return;
        }

        registerMessage = await response.Content.ReadAsStringAsync();
    }

    private async Task LoginAsync()
    {
        registerMessage = null;
        loginMessage = null;

        var response = await Http.PostAsJsonAsync("api/auth/login", loginRequest);
        if (response.IsSuccessStatusCode)
        {
            var user = await response.Content.ReadFromJsonAsync<AuthResponse>();
            await UserState.SetUserAsync(user);
            loginMessage = user is null ? "Login succeeded." : $"Logged in as {user.Username}.";
            loginRequest.Password = string.Empty;
            return;
        }

        loginMessage = await response.Content.ReadAsStringAsync();
    }
}
