@page "/"
@using System.Net.Http.Json
@using InkAndRealm.Shared
@using InkAndRealm.Client.State
@inject HttpClient Http
@inject NavigationManager Navigation
@inject UserState UserState

<PageTitle>Ink & Realm</PageTitle>

<div class="container py-4">
    <h1 class="mb-3">Ink & Realm</h1>
    <p class="text-muted">Start by creating a new map to enter the editor.</p>

    <div class="d-flex gap-2">
        <button class="btn btn-primary"
                disabled="@(!IsLoggedIn || _isCreating)"
                @onclick="CreateMapAsync">
            New Map
        </button>
    </div>

    @if (!IsLoggedIn)
    {
        <div class="alert alert-warning mt-3">Log in to create or edit maps.</div>
    }
    else if (!string.IsNullOrWhiteSpace(_statusMessage))
    {
        <div class="alert alert-info mt-3">@_statusMessage</div>
    }
</div>

@code {
    private bool _isCreating;
    private string _statusMessage = string.Empty;
    private bool IsLoggedIn => UserState.CurrentUser is not null;

    private async Task CreateMapAsync()
    {
        if (!IsLoggedIn)
        {
            _statusMessage = "Please log in to create a new map.";
            return;
        }

        _isCreating = true;
        _statusMessage = "Creating a new map...";

        var response = await Http.PostAsJsonAsync("api/demo-map/new", new CreateMapRequest
        {
            UserId = UserState.CurrentUser?.UserId
        });

        if (response.IsSuccessStatusCode)
        {
            Navigation.NavigateTo("/map-demo");
            return;
        }

        if (response.StatusCode == System.Net.HttpStatusCode.Conflict)
        {
            Navigation.NavigateTo("/map-demo");
            return;
        }
        else
        {
            var message = await response.Content.ReadAsStringAsync();
            _statusMessage = string.IsNullOrWhiteSpace(message)
                ? "Failed to create a new map."
                : message;
        }

        _isCreating = false;
    }
}
