@page "/"
@using System
@using System.Net
@using System.Net.Http.Json
@using InkAndRealm.Shared
@using InkAndRealm.Client.State
@inject HttpClient Http
@inject NavigationManager Navigation
@inject UserState UserState
@implements IDisposable

<PageTitle>Ink & Realm</PageTitle>

<div class="container py-4">
    <h1 class="mb-3">Ink & Realm</h1>
    <p class="text-muted">Create a new map or pick one of your existing maps.</p>

    <div class="d-flex gap-2 mb-3 align-items-center">
        <input class="form-control"
               style="max-width: 320px;"
               placeholder="Map name (optional)"
               disabled="@(!IsLoggedIn || _isCreating)"
               @bind="_newMapName" />
        <button class="btn btn-primary"
                disabled="@(!IsLoggedIn || _isCreating)"
                @onclick="CreateMapAsync">
            New Map
        </button>
    </div>

    @if (!IsLoggedIn)
    {
        <div class="alert alert-warning">Log in to create or edit maps.</div>
    }
    else
    {
        @if (_isLoading)
        {
            <div class="alert alert-info">Loading your maps...</div>
        }
        else if (_maps.Count == 0)
        {
            <div class="alert alert-info">No maps yet. Click New Map to get started.</div>
        }
        else
        {
            <div class="list-group">
                @foreach (var map in _maps)
                {
                    <button type="button"
                            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                            @onclick="() => OpenMap(map.Id)">
                        <span>@map.Name</span>
                        <span class="badge bg-secondary">Map #@map.Id</span>
                    </button>
                }
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(_statusMessage))
        {
            <div class="alert alert-info mt-3">@_statusMessage</div>
        }
    }
</div>

@code {
    private bool _isCreating;
    private bool _isLoading;
    private string _statusMessage = string.Empty;
    private string _newMapName = string.Empty;
    private bool IsLoggedIn => UserState.CurrentUser is not null;
    private List<MapSummaryDto> _maps = new();

    protected override async Task OnInitializedAsync()
    {
        UserState.Changed += OnUserChanged;
        await LoadMapsAsync();
    }

    private async Task CreateMapAsync()
    {
        if (!IsLoggedIn)
        {
            _statusMessage = "Please log in to create a new map.";
            return;
        }

        _isCreating = true;
        _statusMessage = "Creating a new map...";

        var response = await Http.PostAsJsonAsync("api/demo-map/new", new CreateMapRequest
        {
            UserId = UserState.CurrentUser?.UserId,
            SessionToken = UserState.CurrentUser?.SessionToken,
            Name = string.IsNullOrWhiteSpace(_newMapName) ? null : _newMapName.Trim()
        });

        if (response.IsSuccessStatusCode)
        {
            var map = await response.Content.ReadFromJsonAsync<MapDto>();
            if (map is not null)
            {
                _newMapName = string.Empty;
                Navigation.NavigateTo($"/map-demo/{map.Id}");
                return;
            }

            await LoadMapsAsync();
            return;
        }

        if (response.StatusCode == HttpStatusCode.Unauthorized)
        {
            await UserState.SetUserAsync(null);
            _statusMessage = "Your session is no longer valid. Please log in again.";
            _isCreating = false;
            return;
        }

        var message = await response.Content.ReadAsStringAsync();
        _statusMessage = string.IsNullOrWhiteSpace(message)
            ? "Failed to create a new map."
            : message;

        _isCreating = false;
    }

    private async Task LoadMapsAsync()
    {
        if (!IsLoggedIn)
        {
            _maps = new List<MapSummaryDto>();
            _statusMessage = string.Empty;
            return;
        }

        _isLoading = true;
        _statusMessage = string.Empty;

        using var response = await Http.GetAsync(GetMapsUrl());
        if (response.IsSuccessStatusCode)
        {
            var maps = await response.Content.ReadFromJsonAsync<List<MapSummaryDto>>();
            _maps = maps ?? new List<MapSummaryDto>();
            _isLoading = false;
            return;
        }

        if (response.StatusCode == HttpStatusCode.Unauthorized)
        {
            await UserState.SetUserAsync(null);
            _maps = new List<MapSummaryDto>();
            _statusMessage = "Your session is no longer valid. Please log in again.";
            _isLoading = false;
            return;
        }

        var message = await response.Content.ReadAsStringAsync();
        _maps = new List<MapSummaryDto>();
        _statusMessage = string.IsNullOrWhiteSpace(message)
            ? "Failed to load maps."
            : message;
        _isLoading = false;
    }

    private void OpenMap(int mapId)
    {
        Navigation.NavigateTo($"/map-demo/{mapId}");
    }

    private string GetMapsUrl()
    {
        var sessionToken = UserState.CurrentUser?.SessionToken;
        if (!string.IsNullOrWhiteSpace(sessionToken))
        {
            return $"api/demo-map?sessionToken={Uri.EscapeDataString(sessionToken)}";
        }

        var userId = UserState.CurrentUser?.UserId;
        return userId is null ? "api/demo-map" : $"api/demo-map?userId={userId.Value}";
    }

    private void OnUserChanged()
    {
        _ = InvokeAsync(async () =>
        {
            await LoadMapsAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        UserState.Changed -= OnUserChanged;
    }
}
